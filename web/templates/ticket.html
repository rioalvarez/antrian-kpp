<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambil Nomor Antrian</title>
    <link rel="stylesheet" href="/static/css/ticket.css">
</head>
<body class="ticket-body">
    <div class="ticket-container">
        <header class="ticket-header">
            <h1 id="page-title">Sistem Antrian</h1>
            <p id="page-subtitle" class="subtitle" style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.25rem;"></p>
            <div class="datetime" id="datetime"></div>
        </header>

        <main class="ticket-main">
            <div class="welcome-section">
                <h2 id="welcome-text">Selamat Datang</h2>
                <p id="instruction-text">Silakan pilih jenis layanan untuk mengambil nomor antrian</p>
            </div>

            <div class="queue-types-grid" id="queue-types">
                {{range .QueueTypes}}
                <button class="queue-type-btn" onclick="takeQueue('{{.Code}}')" data-code="{{.Code}}">
                    <span class="type-prefix">{{.Prefix}}</span>
                    <span class="type-name">{{.Name}}</span>
                </button>
                {{else}}
                <button class="queue-type-btn" onclick="takeQueue('A')">
                    <span class="type-prefix">A</span>
                    <span class="type-name">Umum</span>
                </button>
                {{end}}
            </div>
        </main>

        <footer class="ticket-footer">
            <a href="/display">Lihat Display Antrian</a>
        </footer>
    </div>

    <!-- Queue Ticket Modal -->
    <div class="modal ticket-modal" id="ticket-modal">
        <div class="modal-content ticket-content">
            <div class="ticket">
                <div class="ticket-header-text">Nomor Antrian Anda</div>
                <div class="ticket-number" id="ticket-number">A001</div>
                <div class="ticket-type" id="ticket-type">Umum</div>
                <div class="ticket-time" id="ticket-time"></div>
                <div class="ticket-footer-text">Mohon menunggu hingga nomor Anda dipanggil</div>
            </div>
            <button class="close-btn" onclick="closeTicketModal()">Tutup</button>
        </div>
    </div>

    <script>
        // Settings
        let settings = {};
        let autoPrintEnabled = true;

        // Load settings from server
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                settings = await response.json();

                // Apply settings to UI
                if (settings.ticket_page_title) {
                    document.getElementById('page-title').textContent = settings.ticket_page_title;
                    document.title = settings.ticket_page_title;
                }
                if (settings.ticket_page_subtitle) {
                    document.getElementById('page-subtitle').textContent = settings.ticket_page_subtitle;
                }
                if (settings.ticket_welcome_text) {
                    document.getElementById('welcome-text').textContent = settings.ticket_welcome_text;
                }
                if (settings.ticket_instruction_text) {
                    document.getElementById('instruction-text').textContent = settings.ticket_instruction_text;
                }

                autoPrintEnabled = settings.ticket_auto_print !== 'false';
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        // Update date time
        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('id-ID', options);
        }

        // Initialize
        loadSettings();
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Take queue
        async function takeQueue(typeCode) {
            const btn = event.currentTarget;
            btn.disabled = true;

            try {
                const response = await fetch(`/api/queues/take?type=${typeCode}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to take queue');
                }

                const queue = await response.json();
                showTicket(queue, typeCode);
            } catch (error) {
                console.error('Failed to take queue:', error);
                alert(error.message || 'Gagal mengambil nomor antrian. Silakan coba lagi.');
            } finally {
                btn.disabled = false;
            }
        }

        // Show ticket modal and auto-print
        async function showTicket(queue, typeCode) {
            const currentTime = new Date().toLocaleString('id-ID');

            // Update modal display
            document.getElementById('ticket-number').textContent = queue.queue_number;
            document.getElementById('ticket-time').textContent = currentTime;

            // Get type name
            let typeName = typeCode;
            try {
                const response = await fetch('/api/queue-types?active=true');
                const types = await response.json();
                const type = types.find(t => t.code === typeCode);
                if (type) {
                    typeName = type.name;
                }
            } catch (e) {
                console.error('Failed to get type name:', e);
            }

            // Update type name in modal
            document.getElementById('ticket-type').textContent = typeName;

            // Show modal
            document.getElementById('ticket-modal').classList.add('show');

            // Auto print ticket to thermal printer via backend API (if enabled)
            if (autoPrintEnabled) {
                printTicket(queue.queue_number, typeName, currentTime);
            }
        }

        // Print ticket to thermal printer via backend API (silent print)
        async function printTicket(queueNumber, typeName, dateTime) {
            try {
                const response = await fetch('/api/print-ticket', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        queue_number: queueNumber,
                        type_name: typeName,
                        date_time: dateTime
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('Print failed:', error.error);
                }
            } catch (error) {
                console.error('Failed to print ticket:', error);
            }
        }

        // Close ticket modal
        function closeTicketModal() {
            document.getElementById('ticket-modal').classList.remove('show');
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeTicketModal();
            }
        });

        // Close modal on outside click
        document.getElementById('ticket-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTicketModal();
            }
        });
    </script>
</body>
</html>
